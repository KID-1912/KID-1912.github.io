---
layout:     post
title:      Vite
subtitle:   下一代的前端工具链
date:       2022-12-14
author:     page
header-img: img/vite+vue.png
catalog: true
tags:
    - vue
---

# Vite

**打包：** 使用工具抓取、处理并将我们的源码模块串联成可以在浏览器中运行的文件。

**更快的启动：** 传统冷启动开发服务器，需要优先抓取并构建你的整个应用（依赖分析并转换）。vite [原生 ESM](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules) 方式提供源码，浏览器请求后按需（如路由拆分）提供源码；此外对依赖预构建（esbuild），对依赖模块转换与依赖关系整合单个模块

**更快的更新：** 传统打包器即使拥有热模块替换(HMR)，依旧要编译并构建与更改内容有依赖关系的部分，vite 通知请求最新 ESM 模块即可；此外还利用缓存机制（对源码协商缓存，对依赖强缓存）

**生产环境打包：** 进行 tree-shaking、懒加载和 chunk 分割（以获得更好的缓存） 

## 创建项目

```shell
npm init vite@latest
pnpm create vite
```

社区模板集合：[GitHub - vitejs/awesome-vite: ⚡️ A curated list of awesome things related to Vite.js](https://github.com/vitejs/awesome-vite#templates)

**可执行命令**

```shell
{
  "scripts": {
    "dev": "vite", // 启动开发服务器，别名：`vite dev`，`vite serve`
    "build": "vite build", // 为生产环境构建产物
    "preview": "vite preview" // 本地预览生产构建产物
  }
}
```

## 功能概览

TS转译

Vue 单文件组件

JSX转译

CSS：PostCSS、CSS Modules、sass/less(安装即可)

静态资源导入

默认构建优化：css代码独立为文件、预加载生成、异步 Chunk 加载优化(同时加载取代层层加载)



Glob 导入、json

## 静态资源处理

**手动引用：**`const module = new URL("@/xxx", import.meta.url)`，支持访问资源路径

```js
export function getAssetFileURL(url) {
  return new URL(`../assets/files/${url}`, import.meta.url).href;
}
```

**动态引入：**`const images = import.meta.glob("@/assets/img/**/*.png", params);`

```js
const gameModules = import.meta.glob(
  "@/assets/img/game/**/*.png", { eager: true }
);
export function getAssetsGameFile(url) {
  return gameModules[`/src/assets/${url}`].default;
}
```

默认匹配结果，以资源路径为key，以资源动态加载方法为value；

`eager: true` 以静态资源 module.default 为value；

`as: 'url'` 以资源路径为value；

## 环境变量

`import.meta.env` 访问环境配置变量

## 配置

### base

资源存放路径，支持绝对/相对路径

### build

- outDir：资源打包输出目录

- commonjsOptions
  
  值设为 `{ transformMixedEsModules: true }` 用于转换 `require` 导出/引入；
  
  部分库使用commonJS规范，需声明此选项转换，否则生产环境报错；

- rollupOptions：rollup打包配置
  
  **资源分类**
  
  ```js
  rollupOptions: {
    output: {
      assetFileNames: (assetInfo) => {
        let info = assetInfo.name.split(".");
        let extType = info[info.length - 1];
        if (/\.(png|jpe?g|gif|svg)(\?.*)?$/.test(assetInfo.name)) {
          extType = "img";
        } else if (/\.(woff2?|eot|ttf|otf)(\?.*)?$/i.test(assetInfo.name)) {
          extType = "fonts";
        }
        return `${extType}/[name]-[hash][extname]`;
      },
      chunkFileNames: "js/[name]-[hash].js",
      entryFileNames: "js/[name]-[hash].js"
    }
  }
  ```

## 插件

### 基础使用

与 rollup 相同，安装插件后 plugins 数组中使用

```js
// vite.config.js
import legacy from '@vitejs/plugin-legacy'
import typescript2 from 'rollup-plugin-typescript2'
import image from '@rollup/plugin-image'
import { defineConfig } from 'vite'

export default defineConfig({
  plugins: [
    legacy({
      targets: ['defaults', 'not IE 11']
    }),
    {
      ...image(),
      enforce: 'pre'  // 强制顺序 pre/post(在vite核心插件之前)
    },
    {
      ...typescript2(),
      apply: 'build' // build/serve 模式生产
    }
  ]
})
```

更多官方插件、社区插件/模板、Rollup插件见 [插件 | Vite 中文文档](https://ptymt.cn/plugins/)

### vite-plugin-html

自定义html模板

```html
<meta name="keywords" content="<%- keywords %>" />
<title><%- title %></title>
```

```js
// vite.config.js
import { defineConfig } from "vite";
import { createHtmlPlugin } from "vite-plugin-html";

// export default defineConfig
plugins: [
  createHtmlPlugin({
    inject: {
      data: { 
        keywords: env.VITE_APP_KEYWORDS,
        title: "页面标题"
      }
    }
  })
]
```

### vite-babel-plugin

```js
// vite.config.js
import babel from "vite-babel-plugin";

// export default defineConfig
plugins: [
  babel()
]
```

### postcss

vite内部集成 `postcss`，无需手动安装；配置与 `webpack` 同理：

```js
// postcss.config.js
module.exports = {
  plugins: {
    "autoprefixer": {
      overrideBrowserslist: ['last 2 version','>1%']
    },
    "postcss-px-to-viewport": {
      viewportWidth: 750,
      exclude: [/node_modules/],
      mediaQuery: true,
    },
  },
};
```

### vite-plugin-svg-icons

- **预加载** 在项目运行时就生成所有图标,只需操作一次 dom
- **高性能** 内置缓存,仅当文件被修改时才会重新生成

```js
// vite.config.js
import { createSvgIconsPlugin } from 'vite-plugin-svg-icons'
import path from 'path'

export default () => {
  return {
    plugins: [
      createSvgIconsPlugin({
        // 指定需要缓存的图标文件夹
        iconDirs: [path.resolve(process.cwd(), 'src/icons')],
        // 指定symbolId格式
        symbolId: 'icon-[dir]-[name]',
        /**
         * 自定义插入位置
         * @default: body-last
         */
        inject?: 'body-last' | 'body-first'
        /**
         * custom dom id
         * @default: __svg__icons__dom__
         */
        customDomId: '__svg__icons__dom__',
      }),
    ],
  }
}
```

**引入**

```js
// main.js
import 'virtual:svg-icons-register'
import SvgIcon from '@/base-ui/SvgIcon/index.vue';

const app = createApp(App);
app.component('SvgIcon', SvgIcon);
```

**SvgIcon**

```html
<template>
  <svg aria-hidden="true">
    <use :xlink:href="symbolId" :fill="color" />
  </svg>
</template>

<script>
import { defineComponent, computed } from 'vue'

export default defineComponent({
  name: 'SvgIcon',
  props: {
    prefix: {
      type: String,
      default: 'icon',
    },
    name: {
      type: String,
      required: true,
    },
    color: {
      type: String,
      default: '#333',
    },
  },
  setup(props) {
    const symbolId = computed(() => `#${props.prefix}-${props.name}`)
    return { symbolId }
  },
})
</script>

<style scoped>
.svg-icon {
  overflow: hidden;
  width: 1em;
  height: 1em;
  fill: currentColor;
  vertical-align: -0.15em;
}
</style>
```

**使用**

```html
<SvgIcon name="edit" :class="{ activated }" />
```
