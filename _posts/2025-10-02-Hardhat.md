# Hardhat

[å®˜ç½‘](https://v2.hardhat.org/) [ä¸­æ–‡æ–‡æ¡£](https://learnblockchain.cn/docs/hardhat/getting-started/)

Hardhat CLIå‘½ä»¤å·¥å…·ï¼ˆå¯æ‹“å±•ä»»åŠ¡è¿è¡Œå™¨ï¼‰ï¼Œå…¶ä¸­**ä»»åŠ¡**æ”¯æŒè¿è¡Œä»»åŠ¡æˆ–å®šä¹‰å¤æ‚å·¥ä½œæµç¨‹ï¼›**æ’ä»¶**æ”¯æŒè¦†ç›–ä»»åŠ¡ï¼Œå®ç°å®šåˆ¶å’Œæ‹“å±•å·¥ä½œæµç¨‹ï¼›

## åŸºç¡€ä½¿ç”¨

### å®‰è£…

```shell
npm i hardhat -S
```

### åˆ›å»ºé¡¹ç›®

```shell
npm hardhat --init
```

å¯é€‰ï¼šhardhat projectï¼ˆold versionï¼‰+ js and ESM

[hardhat@æ–‡æ¡£](https://v2.hardhat.org/hardhat-runner/docs/getting-started) [ethers@6æ–‡æ¡£](https://docs.ethers.org/v6/getting-started)

### è¿è¡Œä»»åŠ¡

```shell
npx hardhat [Task Name]
```

**ç¼©å†™/ç¼–è¯‘åˆçº¦**

```shell
npx hardhat compile
```

### æµ‹è¯•åˆçº¦

```shell
npx hardhat test [å¯é€‰ï¼šæµ‹è¯•çš„è„šæœ¬æ–‡ä»¶å]
```

`test` ç›®å½•ä¸‹æ–‡ä»¶ä¸º**å•å…ƒæµ‹è¯•æˆ–é›†æˆæµ‹è¯•**æä¾›åˆçº¦çš„å®ä¾‹ï¼Œ**éªŒè¯é€»è¾‘æ­£ç¡®æ€§**ï¼Œç‰¹ç‚¹åŒ…æ‹¬ï¼š

**è‡ªåŠ¨è§¦å‘**ï¼šé€šè¿‡ `npx hardhat test` è¿è¡Œï¼Œæ¯è½®æµ‹è¯•éƒ½ä¼š**é‡ç½®æœ¬åœ°é“¾çŠ¶æ€**ï¼ˆæ— æŒä¹…åŒ–å½±å“ï¼‰ã€‚

**åŒ…å«æ–­è¨€**ï¼šå¿…é¡»ç”¨ `descripe` / `it` å’Œ `expect` éªŒè¯ç»“æœã€‚

**éš”ç¦»ç¯å¢ƒ**ï¼šæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„éƒ¨ç½²æ˜¯ç‹¬ç«‹çš„ï¼Œé¿å…çŠ¶æ€æ±¡æŸ“ã€‚

ç”¨äºæµ‹è¯•åˆçº¦å‡½æ•°æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€æ¨¡æ‹Ÿå¤æ‚äº¤äº’ã€æ£€æŸ¥å¼‚å¸¸æƒ…å†µï¼›

```js
import chai from "chai";

const { expect } = chai;

describe("ReceiveETH", function () {
  it("Should receive ETH and return the correct value", async function () {
    // éƒ¨ç½²åˆçº¦
    const ReceiveETH = await ethers.getContractFactory("ReceiveETH");
    const receiveETH = await ReceiveETH.deploy({
      value: ethers.parseEther("1.0"),
    }); // é»˜è®¤éƒ¨ç½²è½¬å…¥1ä¸ªETHè‡³åˆçº¦
    // è·å–åˆçº¦åœ°å€
    const contractAddress = receiveETH.getAddress();
    console.log("receiveETH.address", contractAddress);

    // è·å–hardhatçš„æµ‹è¯•è´¦æˆ·ï¼Œç¬¬1ä¸ªè´¦æˆ·ä¸ºåˆçº¦éƒ¨ç½²è€…(owner)
    const [owner, ...otherAccounts] = await ethers.getSigners();

    // äº¤æ˜“ï¼šå‘åˆçº¦è½¬å…¥1ä¸ªETH
    const tx = await owner.sendTransaction({
      to: contractAddress,
      value: ethers.parseEther("1.0"),
    });
    await tx.wait(); // ç­‰å¾…äº¤æ˜“è¢«æ‰“åŒ…
    // åˆçº¦ä½™é¢
    console.log("receiveETH.balance", await ethers.provider.getBalance(contractAddress));

    // è°ƒç”¨åˆçº¦.getValue()å‡½æ•°
    const value = await receiveETH.getValue();
    console.log("receiveETH.getValue() result", value);

    expect(value).to.equal(ethers.parseEther("2.0"));
  });
});
```

### éƒ¨ç½²åˆçº¦

**å¯åŠ¨Hardhatç½‘ç»œèŠ‚ç‚¹**

`npx hardhat node`ï¼šå¯ç”¨ç‹¬ç«‹èŠ‚ç‚¹è¿è¡ŒHardhatç½‘ç»œï¼Œå°†æš´éœ²ä¸€ä¸ªJSON-RPCæ¥å£è¿æ¥å…è®¸é’±åŒ…æˆ–DAppè®¿é—®ã€‚

**è¿è¡Œéƒ¨ç½²è„šæœ¬**

`script` ç›®å½•ä¸‹æ–‡ä»¶ä¸“ç”¨äºå°†åˆçº¦**æ­£å¼éƒ¨ç½²åˆ°åŒºå—é“¾ç½‘ç»œ**ï¼ˆå¦‚æœ¬åœ°èŠ‚ç‚¹ï¼Œæµ‹è¯•ç½‘æˆ–ä¸»ç½‘ï¼‰

`npx hardhat run scripts/deploy.js`ï¼šé»˜è®¤æƒ…å†µï¼ˆæ—  `network`å‚æ•°ï¼‰å°†éƒ¨ç½²åˆ° Hardhat å†…ç½®çš„æœ¬åœ°å†…å­˜ç½‘ç»œï¼Œæ‰§è¡Œåé”€æ¯ï¼›

```js
import hre from "hardhat";

async function main(){
  // éƒ¨ç½²åˆçº¦
  const ReceiveETH = await hre.ethers.getContractFactory("ReceiveETH"); // è·å–åˆçº¦å·¥å‚å¯¹è±¡
  const receiveETH = await ReceiveETH.deploy({
    value: hre.ethers.parseEther("1.0"),
  });
  await receiveETH.waitForDeployment();

  // åˆçº¦åœ°å€
  const address = await receiveETH.getAddress();
  console.log("receiveETH.address:", address);
}

main().then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

**æ³¨**ï¼šé€šè¿‡ `hardhat.config.js` çš„ `defaultNetwork: "localhost"` æŒ‡å®šè„šæœ¬æ‰§è¡Œé»˜è®¤ç½‘ç»œ

`npx hardhat run scripts/deploy.js --network <localhost/ç½‘ç»œåœ°å€/ç½‘ç»œåç§°>` æŒ‡å®šéƒ¨ç½²åˆ°çœŸå®ç½‘ç»œï¼ˆlocalhostå³hardhatèŠ‚ç‚¹ç½‘ç»œï¼‰

ä¸teståŒºåˆ«ï¼šscripts å¯ä»¥ç†è§£ä¸ºè„šæœ¬ï¼Œå³æ‰‹åŠ¨æ‰§è¡Œé€»è¾‘æ–‡ä»¶ï¼Œå¦‚å•è¯éƒ¨ç½²/äº¤äº’çš„åœºæ™¯ï¼›

## è„šæœ¬script

### ç›‘å¬åˆçº¦event

```js
import hre from "hardhat";
const { ethers } = hre;
const provider = hre.ethers.provider; 
provider.pollingInterval = 1000; // è®¾ç½®ä»¥å¤ªåŠæä¾›è€…è½®è¯¢é—´éš”ï¼Œå†³å®šäº‹ä»¶ç›‘å¬å“åº”é€Ÿåº¦

async function main(){
  // éƒ¨ç½²åˆçº¦
  const ReceiveETH = await hre.ethers.getContractFactory("ReceiveETH");
  const receiveETH = await ReceiveETH.deploy({
    value: hre.ethers.parseEther("1.0"),
  });
  await receiveETH.waitForDeployment();

  // åˆçº¦åœ°å€
  const address = await receiveETH.getAddress();
  console.log("receiveETH.address:", address);

  // ç›‘å¬åˆçº¦äº‹ä»¶
  receiveETH.on("Received", (...args) = {
    const event = args.pop(); // å–å‡ºEventè®°å½•å€¼
    console.log("Event Log:", ...args);
  })
}

main()
  // .then(() => process.exit(0)) æ­¤å¤„æŒç»­è¿è¡Œä¸å…³é—­
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

### è¿æ¥åˆçº¦

```js
import hre from "hardhat";
import { deploy } from "./deploy.js";

async function main() {
  // éƒ¨ç½²SendETHåˆçº¦
  const { address: contractAddress } = await deploy(); // è¿”å›å®ä¾‹åœ°å€
  const Contract = await hre.ethers.getContractFactory("SendETH");
  const contractInstance = Contract.attach(contractAddress); // è¿æ¥å·²å­˜åœ¨çš„åˆçº¦
}
```

## ä»»åŠ¡Task

é€šè¿‡åˆ›å»ºä»»åŠ¡ä¸ä½ çš„åˆçº¦è¿›è¡Œ**äº¤äº’**æˆ–**æ‰“åŒ…**é¡¹ç›®

**Taskä½¿ç”¨**ï¼š`Usage: hardhat [GLOBAL OPTIONS] <TASK> [TASK OPTIONS]`

**é»˜è®¤æ”¯æŒå‚æ•°**ï¼šï¼ˆæ‰€æœ‰hardhat tasks æ”¯æŒï¼‰

```textile
  --config              A Hardhat config file.
  --emoji               Use emoji in messages.
  --help                Shows this message, or a task's help if its name is provided
  --max-memory          The maximum amount of memory that Hardhat can use.
  --network             The network to connect to.
  --show-stack-traces   Show stack traces.
  --tsconfig            A TypeScript config file.
  --verbose             Enables Hardhat verbose logging
  --version             Shows hardhat's version.
```

**å…¨å±€ä»»åŠ¡**ï¼š

```textile
  check                 Check whatever you need
  clean                 Clears the cache and deletes all artifacts
  compile               Compiles the entire project, building all artifacts
  console               Opens a hardhat console
  coverage              Generates a code coverage report for tests
  flatten               Flattens and prints contracts and their dependencies
  help                  Prints this message
  node                  Starts a JSON-RPC server on top of Hardhat Network
  run                   Runs a user-defined script after compiling the project
  test                  Runs mocha tests
  typechain             Generate Typechain typings for compiled contracts
  verify                Verifies contract on Etherscan
```

**taskï¼šæŸ¥è¯¢ä½™é¢**

```js
task("balance", "Prints an account's balance")
  .addParam("account", "The account's address")
  .setAction(async (taskArgs, hre) => {
    const { ethers } = hre;
    const address = taskArgs.account;

    try {
      // 1. æ£€æŸ¥å½“å‰ç½‘ç»œè¿æ¥
      const currentNetwork = await ethers.provider.getNetwork();
      console.log("å½“å‰è¿æ¥ç½‘ç»œ:", currentNetwork.name);
      console.log("ç½‘ç»œID:", currentNetwork.chainId);

      // 2. éªŒè¯åœ°å€
      if (!ethers.isAddress(address)) {
        console.error("âŒï¸æ— æ•ˆçš„ä»¥å¤ªåŠåœ°å€:", address);
        return;
      }

      // 3. è·å–ä½™é¢
      const balanceWei = await ethers.provider.getBalance(address);
      const balanceETH = ethers.formatEther(balanceWei);

      console.log("ğŸ’°ä½™é¢ï¼š", balanceETH, "ETH");
      console.log("âš¡ï¸Weiå€¼ï¼š", balanceWei, "Wei");
    } catch (error) {
      console.error("âŒï¸è·å–ä½™é¢å¤±è´¥:", error.message);
    }
  });
```

**åŠ è½½ä»»åŠ¡**

```js
// hardhat.config.cjs
require("./tasks/balance");
```

æ‰§è¡Œå‘½ä»¤ï¼š`npx hardhat balance  --account <address> --netowrk localhost`

**taskï¼šè½¬è´¦ETH**

```js
task("transfer", "è½¬è´¦ ETH")
  .addParam("toAddress", "æ¥æ”¶æ–¹åœ°å€")
  .addOptionalParam("fromAddress", "è½¬è´¦æ–¹åœ°å€")
  .addOptionalParam("amount", "è½¬è´¦é‡‘é¢ï¼ˆETHï¼‰", "1.0")
  .setAction(async (taskArgs, hre) => {
    const { ethers } = hre;
    const { fromAddress, toAddress } = taskArgs;

    const signers = await ethers.getSigners();
    const sender = taskArgs.fromAddress
      ? signers.find(
          (signer) =>
            signer.address.toLowerCase() === taskArgs.fromAddress.toLowerCase()
        )
      : signers[0];

    // éªŒè¯å‚æ•°
    if (!sender) {
      if (ethers.isAddress(fromAddress)) {
        console.error("âŒï¸fromAddresså¿…é¡»æ˜¯signersä¸­çš„ä¸€ä¸ª", fromAddress);
      } else {
        console.error("âŒï¸æ— æ•ˆçš„fromAddressåœ°å€:", fromAddress);
      }
    }
    if (!ethers.isAddress(toAddress)) {
      console.error("âŒï¸æ— æ•ˆçš„toAddressåœ°å€:", toAddress);
    }

    // æ‰§è¡Œè½¬è´¦
    const amountETH = taskArgs.amount;
    const amountWei = ethers.parseEther(amountETH);
    console.log(
      `ğŸš€ æ­£åœ¨ä» ${sender.address} å‘ ${toAddress} è½¬è´¦ ${amountETH} ETH...`
    );
    const tx = await sender.sendTransaction({
      to: toAddress,
      value: amountWei,
    });

    const receipt = await tx.wait();

    if (receipt.status === 1) {
      console.log("âœ…è½¬è´¦æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ:", tx.hash);
      console.log("ğŸ“¦åŒºå—ï¼š", receipt.blockNumber);
      console.log("â›½ï¸Gasæ¶ˆè€—ï¼š", receipt.gasUsed.toString());

      // ä½™é¢å˜åŒ–
      const senderBalance = await ethers.provider.getBalance(sender.address);
      console.log(`ğŸ’° senderæ–°ä½™é¢:`, ethers.formatEther(senderBalance), "ETH");
      const receiverBalance = await ethers.provider.getBalance(toAddress);
      console.log(
        `ğŸ’° toAddressæ–°ä½™é¢:`,
        ethers.formatEther(receiverBalance),
        "ETH"
      );
    } else {
      console.error("âŒï¸è½¬è´¦å¤±è´¥ï¼");
    }
  });
```

## æ§åˆ¶å°Console

`npx hardhat console` è¿›å…¥Hardhatè¿è¡Œæ—¶è¿è¡Œç¯å¢ƒ

```shell
const hre = require("hardhat");
await hre.ethers.provider.getBalance("0x5Fb...");
```

æŒ‡å®šç½‘ç»œè¿è¡Œç¯å¢ƒï¼š`npx hardhat console --network localhost`

**æŸ¥çœ‹åˆçº¦çŠ¶æ€**

```powershell
const SendETH = await ethers.getContractFactory("SendETH")
const sendETH = await SendETH.attach("0x5FbDB2315678afecb367f032d93F642f64180aa3") # ä½ çš„åˆçº¦åœ°å€

# æŸ¥çœ‹çŠ¶æ€å˜é‡
await sendETH.receiveETHContract()
# è¾“å‡ºï¼š'0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512'

# æŸ¥çœ‹Mappingç±»å‹å˜é‡
await sendETH.transferRecordsMapping("0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266")

# æŸ¥çœ‹å…¶ä»– public å˜é‡ï¼ˆå¦‚æœæœ‰ï¼‰
await sendETH.owner() # å¦‚æœæœ‰è¿™ä¸ªå˜é‡
```

## é…ç½®Config

```js
// hardhat.config.js
require("@nomicfoundation/hardhat-toolbox");
// Tasks Register
require("./tasks/transfer");
require("./tasks/balance");

/** @type import('hardhat/config').HardhatUserConfig */
module.exports = {
  solidity: "0.8.28",
  defaultNetwork: "localhost", // é»˜è®¤ç½‘ç»œ
  networks: {
    localhost: {
      gasPrice: 1000000000, // è®¾ç½®gasPrices
    },
  },
};
```

## HardhatåŒ…è£…

### æµ‹è¯•ç½‘ç»œ

æä¾› `hre.ethers.provider` æä¾›è¿æ¥çš„æµ‹è¯•ç½‘ç»œè®¿é—®

### å·¥å…·å‡½æ•°

```js
hre.ethers.getContractFactory()
hre.ethers.getSigners()
```
