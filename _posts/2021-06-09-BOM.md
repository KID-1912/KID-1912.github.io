---
layout:     post
title:      BOM
subtitle:   浏览器行为控制
date:       2021-6-09
author:     page
header-img: img/wallhaven-3km3v9_1920x1080.png
catalog: true
tags:
    - javascript
    - BOM
---

# BOM

## 浏览器回退

### 需求

在开发中需要监听浏览器回退到当前页面后，执行一些操作：如重新请求初始化数据；但不同浏览器对页面回退处理不一致

- 浏览器回退行为
  - PC浏览器与微信webview：回退后立即会通过刷新重开一个新的页面副本
  - 部分手机内置浏览器：回退后页面即离开时页面，即原文档状态从未改变，会话未关闭过(页面跳转只是新开个标签页)
  - 第三方浏览器：回退时读取缓存的html文件,即原文档状态未改变，但会话关闭过

注：从上面的行为得知，在微信页面回退时并不需要额外添加初始化处理，应为回退页面会自动重新执行

- 如何监听当前页面在回退进入时
  - popstate
  - visibilitychange
  - pageshow

1. popstate

- HTML5中history的新API之一，使用history.pushState()为单页面伪造一个历史记录状态(必须在有交互时)；当单页面的历史记录状态改变时，触发window.popstate事件；

```js
btn.addEventListener("click", function(){ // 修改页面历史记录状态
  history.pushState({ ...stateData }, null, "#otherPage");
})

window.addEventListener("popstate", function(){
  if(!stateData || !location.hash) {
    // ...页面状态回退处理
  }
})
```

popstate监听页面回退仅支持单页面内部历史记录状态回退，与vue router的导航守卫钩子类似；历史记录回退没有任何关联；

2. visibilitychange

- 监听页面可见属性改变，常用来判断页面标签切换，页面进入前台/退出后台切换，屏幕休眠/显示切换；

```js
  window.isLeaved = false; // 记录页面是否处于已离开状态

  btn.addEventListener("click", function(){ // 离开页面事件
    window.willLeave = true; // 记录页面将要离开
    location.href = "https://www.baidu.com";
  })

  document.addEventListener("visibilitychange", e => {
    let v = document.visibilityState;
    if (v == "visible") {
      // 页面从不可见变为可见 判断是否为页面回退的情况
      if(window.isLeaved) {
        window.isLeaved = false;
        // ... 页面回退处理
      }
    } else {
      // 页面从可见变不可见 判断是否为页面离开情况
      if(window.willLeave) {
        window.isLeaved = true; // 记录页面处于离开状态
        window.willLeave = false;
      }
    }
  });

```

visibilitychange事件在页面可见性改变时触发，因此首次加载时不会触发的；
上面代码，在由于页面跳转导致页面不可见时标记值，页面回显显示时判断值来决定是否为页面回退导致页面可见，执行页面回退处理；

但在部分第三方浏览器中，页面被回退后从缓存中读取页面，原页面的visibilitychange从不可见变为可见的处理不会被监听到；且微信页面回退直接刷新原页面，同样不会执行；
